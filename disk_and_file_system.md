学习 linux 中 磁盘和文件系统的使用

几个疑问：
- 日志式文件系统原理？
    将文件系统更新信息记录到某些特定的扇区中，当系统重启的时候，通过读取 journal 扇区的内容即可判断，当前文件系统的内容是否满足一致性。

- 挂载的时候，发生了什么呢？

    >并不是我们有文件系统就可以直接使用，必须要**挂载**到目录树的某个目录后，才能够使用该文件系统。
- 如何查看磁盘分区信息？每个分区的文件系统类型、挂载点？

    使用`lsblk`可以查看系统上所有磁盘列表。常见选项包括：
    - `-d` 仅列出磁盘，不包括分区
    - `-f` 列出文件系统以及UUID
    - `-p` 列出设备完整路径名

- 查看磁盘分区表类型以及分区信息
    `parted 设备文件名 print`

- 硬链接与软链接
  只需要注意：
  - 硬链接无法跨文件系统，因为索引节点号只在当前文件系统才有意义
  - 无法对目录进行硬链接
  
- 如果想在系统里面新增一颗磁盘，需要做什么呢？
  - 对磁盘进行分区

    使用`g/fdisk`(fdisk 适用于 MBR(Master Boot Record)分区磁盘, gdisk 适用于GPT(GUID Partition Table)分区磁盘)可以对磁盘进行分区。键入`n`开始分区，分区完毕后，可以先通过 `p` 查看分区是否正确，正确的话，键入`w`保存新建分区。
    > 注意：gdisk 分区磁盘后，并不会马上在系统生效。要生效有两种方式，一种是重新开机，另一种方式是使用`partprobe`.
  - 对磁盘进行格式化

    所谓格式化其实就是创建文件系统，可以使用`mkfs -t file_system_type 设备文件名`或者`mkfs.file_system_type 设备文件名`。比如将设备文件/dev/sda2 设置为 ext4 文件系统，则可以`mkfs -t ext4 /dev/sda2` 或者 `mkfs.ext4 /dev/sda2`。

    如何查看当前系统都支持哪些文件系统呢？`mkfs tab tab`
  - 挂载到系统目录上
    使用`mount`将block device 挂载到某个目录上。常见的使用方式为：
    - `mount` 显示系统当前所有的挂载信息
    - `mount -a` 依照配置文件`/etc/fstab`将所有未挂载的 block device 都挂载上来
    - `mount [-t 文件系统] UUID='' 挂载点`
    > 系统会为每一个 block device 分配一个 UUID，可以通过`lsblk -f`查看每个block device 的 UUID
    - `mount [-t 文件系统] 设备文件名 挂载点`
    - `-o` 指定额外的参数，包括(ro/rw、exec/noexec、defaults、remount)等。
    > 如果出于某种原因要重新挂载根目录(比如：根目录只读)，如何操作呢？`mount -n -o remount,rw /`

- mbr 与 gpt 分区表的区别？
    mbr 只能管理容量 <= 2T 的磁盘， 而且分区数量有限。

- 如何设置开机挂载
    只需要修改配置文件`/etc/fstab`，每一条 entry，包括 6 个 item。其含义为：
    - 设备文件名/UUID
    - 挂载点
    - 文件系统
    - 挂载参数(rw/ro、exec/noexec等，通常设置为 defaults)
    - dump  # 通常设置为0
    - fsck  # 通常设置为0

    > 特别注意：如果修改 `/etc/fstab` 内容不当，会导致系统启动失败。因此在修改此文件后，我们需要通过`mount -a`命令确认当前挂载是否生效。`mount -a` 会执行`/etc/fstab`中未生效的配置

- 创建设备文件

    创建方式：mknod()系统调用 or mknod。通常系统会自动创建设备文件。但是在一些无法访问到`/dev/*`的特殊场景下(通过 `chroot` 更改了进程的目录)就需要我们自己创建设备文件。

    创建设备文件需要指定： 设备文件名 设备文件类型(b: 块设备 c: 字符设备) 主设备号 次设备号。

- 交换空间
  - 什么是交换空间
    当 mem 不足的时候，就需要将哪些暂时不执行的进程的页存储到交换空间，从而能够释放占用的页。目前计算机的内存足够大，但以防万一，还是需要创建交换空间，只是不建议交换空间太大.

  - 如何设置交换空间的大小？太大太小会有什么问题吗？
    太大 会造成空间浪费。太小 可能无法有效缓解 mem 不足问题。

    创建方式有两种：
    - 可以使用某个分区作为 swap
      - 使用`g/fdisk`在磁盘上创建分区，注意 code=8200，即 linux swap。假设创建设备文件名为`/dev/sda3`
      - 使创建的分区生效`partprobe`
      - 类似于mkfs 命令格式化分区创建文件系统，我们需要使用`mkswap /dev/sda3`来初始化此分区
      - 使用`swapon /dev/sda3`生效该 swap
      - 使用`swapon -s` 查看所有生效的 swap device or file

    - 可以指定某个文件作为 swap
      - 通过`dd if=/dev/zero of=/tmp/swap bs=1M count=128` 创建大小为 128M 文件
      - 通过`mkswap /tmp/swap` 初始化此文件
      - 通过`swapon /tmp/swap` 生效该 swap
      - 通过`swapon -s` 查看此 swap file 是否生效

    其他：
    - 可以使用`swapoff device/file` 取消 swap
    - 如果要设置开机生效的话，可以在文件`/etc/fstab`中加入(以`/tmp/swap`举例)：
        `/tmp/swap     swap    swap    defaults 0 0`
        > 注意，挂载点 和 类型 都是 `swap`

- 如何卸载设备文件
    使用`umount 挂载点`

- 查看文件系统空间使用

    使用 `df` 可以查看当前系统所有文件系统的磁盘使用量. `df 目录/文件`显示当前所在的文件系统的磁盘使用量，如果要查看当前文件系统的类型，可以使用选项`-T`。

- 查看文件/目录空间使用

    使用`du 目录/文件` 可以查看文件/目录的磁盘使用(disk usage)，常见选项:
    - 如果是目录，默认当前目录及所有字母的磁盘使用量。
    - `-s` s 即 summersize，只查看当前目录的磁盘使用量。
    - `-S` 不包括子目录的统计
    - `--exclude`/`--exclude-from` 排除一些文件
    - `-a` 除了展示子目录外，还展示所有文件
    - `-h` human-reading，以人类可读的容量格式展示